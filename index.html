import os
import json
import requests
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from pyrogram import Client, filters
from pyrogram.types import ReplyKeyboardMarkup, KeyboardButton
from threading import Thread
from flask import Flask

# ---------------------------
# Pyrogram Bot Setup
# ---------------------------
BOT_TOKEN = os.getenv("BOT_TOKEN", "YOUR_BOT_TOKEN_HERE")
API_ID = int(os.getenv("API_ID", "YOUR_API_ID_HERE"))
API_HASH = os.getenv("API_HASH", "YOUR_API_HASH_HERE")

app = Client("location_bot", api_id=API_ID, api_hash=API_HASH, bot_token=BOT_TOKEN)

# ---------------------------
# Conversation State Setup
# ---------------------------
user_state = {}

# Conversation state constants
STATE_NAME = 1
STATE_ADDRESS = 2
STATE_TYPE = 3
STATE_YEAR = 4
STATE_EXTRA = 5
STATE_EXTRA2 = 6

# Options for type and year
TYPE_OPTIONS = [
    "Hydroelectric Plants", "Ramsar sites", "IVC Site", "Historical Port",
    "Lakes", "Places in news", "Places in news (IR)", "temples", "other"
]
YEAR_OPTIONS = ["test series", "PYQ"]

def reset_state(chat_id):
    """Reset conversation state for the given chat."""
    user_state[chat_id] = {
        "state": None,
        "name": None,
        "address": None,
        "type": None,
        "year": None,
        "extra info": None,
        "extra info 2": None
    }

# ---------------------------
# Google Sheets Integration
# ---------------------------
def push_to_sheet(entry):
    """
    Push the provided entry to the "Crowd" worksheet within the overall
    spreadsheet named "mapping". If the "Crowd" worksheet is empty, headers
    are added automatically.
    """
    scope = ["https://spreadsheets.google.com/feeds",
             "https://www.googleapis.com/auth/drive"]
    # Load credentials from your JSON file
    creds = ServiceAccountCredentials.from_json_keyfile_name("credentials.json", scope)
    client = gspread.authorize(creds)
    
    # Open the overall spreadsheet named "mapping"
    spreadsheet = client.open("mapping")
    
    # Open the worksheet named "Crowd"
    crowd_sheet = spreadsheet.worksheet("Crowd")
    
    # Optional: If the sheet is empty, insert headers.
    if not crowd_sheet.get_all_values():
        headers = ["Name", "Latitude", "Longitude", "type", "year", "extra info", "extra info 2", "Image"]
        crowd_sheet.append_row(headers)
    
    # Prepare the row data using provided entry values
    row = [
        entry.get("Name", ""),
        entry.get("Latitude", ""),
        entry.get("Longitude", ""),
        entry.get("type", ""),
        entry.get("year", ""),
        entry.get("extra info", ""),
        entry.get("extra info 2", ""),
        entry.get("Image", "")
    ]
    
    crowd_sheet.append_row(row)

# ---------------------------
# Command Handlers
# ---------------------------
@app.on_message(filters.command("start"))
def start(client, message):
    chat_id = message.chat.id
    reset_state(chat_id)
    user_state[chat_id]["state"] = STATE_NAME
    message.reply(
        "üëã Welcome!\n"
        "Please enter the name of the location (e.g., 'Taj Mahal').\n"
        "Type /cancel at any time to abort."
    )

@app.on_message(filters.command("cancel"))
def cancel(client, message):
    chat_id = message.chat.id
    reset_state(chat_id)
    message.reply("‚ùå Operation cancelled. Type /start to begin again.")

@app.on_message(filters.command("help"))
def help_command(client, message):
    message.reply(
        "‚ÑπÔ∏è Commands:\n"
        "/start - Begin adding a location\n"
        "/cancel - Abort the current operation\n"
        "/help - Show this help message"
    )

@app.on_message(filters.text)
def handle_text(client, message):
    text_in = message.text.strip()
    if text_in.lower() == "/cancel":
        cancel(client, message)
        return

    chat_id = message.chat.id
    if chat_id not in user_state:
        reset_state(chat_id)
    state = user_state[chat_id].get("state")
    
    if state == STATE_NAME:
        if not text_in:
            message.reply("‚ö†Ô∏è Please provide a valid location name.")
            return
        user_state[chat_id]["name"] = text_in
        user_state[chat_id]["state"] = STATE_ADDRESS
        message.reply("‚úÖ Great! Now enter additional address details (e.g., 'Agra, India') for better geocoding.")
    
    elif state == STATE_ADDRESS:
        if not text_in:
            message.reply("‚ö†Ô∏è Please enter some address details (e.g., 'Agra, India').")
            return
        user_state[chat_id]["address"] = text_in
        user_state[chat_id]["state"] = STATE_TYPE
        keyboard = ReplyKeyboardMarkup(
            [[KeyboardButton(text=opt)] for opt in TYPE_OPTIONS],
            one_time_keyboard=True,
            resize_keyboard=True
        )
        message.reply("üëâ Please choose the type:", reply_markup=keyboard)
    
    elif state == STATE_TYPE:
        if text_in not in TYPE_OPTIONS:
            message.reply("‚ö†Ô∏è Please choose a valid type from the options provided.")
            return
        user_state[chat_id]["type"] = text_in
        user_state[chat_id]["state"] = STATE_YEAR
        keyboard = ReplyKeyboardMarkup(
            [[KeyboardButton(text=opt)] for opt in YEAR_OPTIONS],
            one_time_keyboard=True,
            resize_keyboard=True
        )
        message.reply("üëâ Please choose the year category:", reply_markup=keyboard)
    
    elif state == STATE_YEAR:
        if text_in not in YEAR_OPTIONS:
            message.reply("‚ö†Ô∏è Please choose a valid year category (either 'test series' or 'PYQ').")
            return
        user_state[chat_id]["year"] = text_in
        user_state[chat_id]["state"] = STATE_EXTRA
        message.reply("üëâ Please provide a one-line extra info (or type /skip to use the default 'other').")
    
    elif state == STATE_EXTRA:
        if text_in.lower() == "/skip":
            user_state[chat_id]["extra info"] = "other"
        else:
            user_state[chat_id]["extra info"] = text_in
        user_state[chat_id]["state"] = STATE_EXTRA2
        message.reply("üëâ Optionally, enter your Telegram name or pseudonym for extra info 2 (or type /skip to use 'other').")
    
    elif state == STATE_EXTRA2:
        if text_in.lower() == "/skip":
            user_state[chat_id]["extra info 2"] = "other"
        else:
            user_state[chat_id]["extra info 2"] = text_in

        # Proceed with geocoding.
        name = user_state[chat_id].get("name", "")
        addr = user_state[chat_id].get("address", "")
        query = f"{name}, {addr}"
        url = "https://nominatim.openstreetmap.org/search"
        params = {"q": query, "format": "json", "limit": 1}
        headers = {"User-Agent": "YourLocationBot/1.0 (your-email@example.com)"}
        try:
            response = requests.get(url, params=params, headers=headers, timeout=10)
            results = response.json()
        except Exception as e:
            message.reply(f"‚ùå Error during geocoding: {e}")
            reset_state(chat_id)
            return
        
        if results:
            latitude = results[0].get("lat", "")
            longitude = results[0].get("lon", "")
        else:
            message.reply("‚ö†Ô∏è Geocoding returned no results. This might be due to an incomplete or ambiguous address. Please check your entry and try again.")
            reset_state(chat_id)
            return
        
        entry = {
            "Name": name,
            "Latitude": latitude,
            "Longitude": longitude,
            "type": user_state[chat_id].get("type", ""),
            "year": user_state[chat_id].get("year", ""),
            "extra info": user_state[chat_id].get("extra info", ""),
            "extra info 2": user_state[chat_id].get("extra info 2", ""),
            "Image": ""
        }
        try:
            push_to_sheet(entry)
            message.reply("üôè Thank you for crowdsourcing and supporting the project!")
        except Exception as e:
            message.reply(f"‚ùå Failed to push data to Google Sheets: {e}\n(Check your credentials and sheet sharing settings.)")
        reset_state(chat_id)
    
    else:
        message.reply("üëâ Please type /start to begin or /cancel to abort.")

# ---------------------------
# Flask Health Check Setup
# ---------------------------
health_app = Flask(__name__)

@health_app.route("/")
def health_check():
    return "OK", 200

def run_health_app():
    port = int(os.environ.get("PORT", 10000))
    health_app.run(host="0.0.0.0", port=port)

# ---------------------------
# Main Execution
# ---------------------------
if __name__ == "__main__":
    # Start the Flask health check server in a separate thread.
    health_thread = Thread(target=run_health_app)
    health_thread.daemon = True
    health_thread.start()
    
    print("üöÄ Health check endpoint is running.")
    print("üöÄ Starting Pyrogram bot...")
    app.run()
